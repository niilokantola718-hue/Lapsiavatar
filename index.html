<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lapsi Avatar - Kokemus</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            z-index: 100;
            max-width: 300px;
        }
        button {
            padding: 12px 24px;
            font-size: 18px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #45a049;
        }
        #enterButton {
            z-index: 1000;
            position: relative;
        }
    </style>
</head>
<body>
    <div id="info">
        <h3>Lapsi Avatar</h3>
        <p>Paina "Astu kehoon" siirtyäksesi avatarin näkökulmaan</p>
        <button id="enterButton">Astu kehoon</button>
        <p id="instructions" style="display:none; margin-top:10px;">
            Liiku: WASD<br>
            Katso: Hiiri/touch<br>
            Poistu: ESC
        </p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/jsm/controls/PointerLockControls.js"></script>

    <script>
        // PÄÄMUUTTUJAT
        let camera, scene, renderer;
        let avatar, firstPersonMode = false;
        let controls;

        // ALUSTUS
        function init() {
            console.log("Alustetaan sovellusta...");
            
            // Luo scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            // Luo kamera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 5);

            // Luo renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Valaistus
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 100, 50);
            scene.add(directionalLight);

            // Maailma
            createWorld();

            // Avatar
            avatar = createAvatar();
            scene.add(avatar);

            // Tapahtumakäsittelijät - TÄRKEÄ: Varmista että nappi löytyy
            const enterButton = document.getElementById('enterButton');
            console.log("Nappi löytyy:", enterButton);
            
            if (enterButton) {
                enterButton.addEventListener('click', switchToFirstPerson);
                console.log("Tapahtumankäsittelijä lisätty napille");
            } else {
                console.error("Nappia ei löydy!");
            }

            window.addEventListener('resize', onWindowResize);

            // Animaatio
            animate();
        }

        function createWorld() {
            // Lattia
            const floorGeometry = new THREE.PlaneGeometry(50, 50);
            const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x90EE90 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Muutama esine
            const box = new THREE.Mesh(
                new THREE.BoxGeometry(2, 2, 2),
                new THREE.MeshStandardMaterial({ color: 0xff0000 })
            );
            box.position.set(5, 1, 0);
            scene.add(box);

            const sphere = new THREE.Mesh(
                new THREE.SphereGeometry(1.5, 32, 32),
                new THREE.MeshStandardMaterial({ color: 0x0000ff })
            );
            sphere.position.set(-5, 1.5, 3);
            scene.add(sphere);
        }

        function createAvatar() {
            const group = new THREE.Group();

            // Vartalo
            const bodyGeometry = new THREE.CylinderGeometry(0.3, 0.3, 1.2, 8);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x4169E1 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0.6;
            group.add(body);

            // Pää
            const headGeometry = new THREE.SphereGeometry(0.25, 16, 16);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xFFEBCD });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.35;
            group.add(head);

            return group;
        }

        function switchToFirstPerson() {
            console.log("Astu kehoon - nappia painettu!");
            if (firstPersonMode) {
                console.log("Jo ensimmäisen persoonan tilassa");
                return;
            }
            
            firstPersonMode = true;
            console.log("Siirrytään ensimmäisen persoonan näkymään...");
            
            // Siirrä kamera avatarin päähän
            const head = new THREE.Group();
            head.position.set(0, 1.3, 0); // Lapsen silmien korkeus
            avatar.add(head);
            head.add(camera);
            camera.position.set(0, 0, 0);
            camera.rotation.set(0, 0, 0);
            
            // Päivitä info
            document.getElementById('enterButton').style.display = 'none';
            document.getElementById('instructions').style.display = 'block';
            
            // Hiiriohjaus
            try {
                controls = new THREE.PointerLockControls(camera, renderer.domElement);
                
                renderer.domElement.addEventListener('click', function() {
                    console.log("Klikattiin renderöintialuetta - otetaan hiiri hallintaan");
                    controls.lock();
                });
                
                controls.addEventListener('lock', function() {
                    console.log('Hiiri otettu hallintaan - voit kääntää katsetta');
                });
                
                controls.addEventListener('unlock', function() {
                    console.log('Hiiri vapautettu');
                });
            } catch (error) {
                console.error("Virhe PointerLockControlsissa:", error);
            }
            
            console.log('Olet nyt avatarin näkökulmassa!');
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Liikkuminen
        const moveState = { forward: false, backward: false, left: false, right: false };
        const moveSpeed = 5;
        
        document.addEventListener('keydown', onKeyDown);
        document.addEventListener('keyup', onKeyUp);

        function onKeyDown(event) {
            switch (event.code) {
                case 'KeyW': moveState.forward = true; break;
                case 'KeyS': moveState.backward = true; break;
                case 'KeyA': moveState.left = true; break;
                case 'KeyD': moveState.right = true; break;
                case 'Escape': 
                    if (controls) controls.unlock();
                    break;
            }
        }

        function onKeyUp(event) {
            switch (event.code) {
                case 'KeyW': moveState.forward = false; break;
                case 'KeyS': moveState.backward = false; break;
                case 'KeyA': moveState.left = false; break;
                case 'KeyD': moveState.right = false; break;
            }
        }

        function updateMovement(delta) {
            if (!firstPersonMode || !controls || !controls.isLocked) return;
            
            if (moveState.forward) controls.moveForward(moveSpeed * delta);
            if (moveState.backward) controls.moveForward(-moveSpeed * delta);
            if (moveState.left) controls.moveRight(-moveSpeed * delta);
            if (moveState.right) controls.moveRight(moveSpeed * delta);
            
            // Päivitä avatarin sijainti kameran mukaan
            avatar.position.copy(camera.position);
            avatar.position.y -= 1.3;
        }

        // Animaatio
        function animate() {
            requestAnimationFrame(animate);
            
            const delta = 0.016; // Noin 60 FPS
            
            if (firstPersonMode) {
                updateMovement(delta);
            } else {
                // Kolmannen persoonan kamera
                const timer = Date.now() * 0.0001;
                camera.position.x = Math.sin(timer) * 5;
                camera.position.z = Math.cos(timer) * 5;
                camera.lookAt(avatar.position);
            }
            
            renderer.render(scene, camera);
        }

        // Varmista että sivu on ladattu ennen kuin aloitetaan
        window.addEventListener('load', function() {
            console.log("Sivu ladattu, aloitetaan alustus...");
            init();
        });
    </script>
</body>
</html>
