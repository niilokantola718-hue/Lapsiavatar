<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Lapsi Avatar - Vision Pro AR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
        }

        h1 {
            font-size: 3em;
            margin-bottom: 20px;
            color: #ff6b6b;
            text-align: center;
        }

        .subtitle {
            font-size: 1.3em;
            margin-bottom: 30px;
            text-align: center;
            max-width: 80%;
            line-height: 1.5;
        }

        #start-button {
            padding: 20px 40px;
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.3);
            transition: all 0.3s ease;
            margin: 10px;
        }

        #start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(78, 205, 196, 0.4);
        }

        #start-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #status {
            margin-top: 20px;
            font-size: 1.1em;
            text-align: center;
            padding: 0 20px;
            min-height: 60px;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid rgba(255, 107, 107, 0.3);
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #xr-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        #webgl-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        #exit-button {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 12px 24px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            cursor: pointer;
            z-index: 1001;
            display: none;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 20px;
            margin-top: 30px;
            max-width: 500px;
            text-align: left;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-panel h3 {
            color: #4ECDC4;
            margin-bottom: 10px;
        }

        .hidden {
            display: none !important;
        }

        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1002;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <!-- XR Container - Vision Pro hoitaa kameran n√§ytt√§misen -->
    <div id="xr-container">
        <canvas id="webgl-canvas"></canvas>
    </div>

    <!-- UI container -->
    <div id="ui-container">
        <h1>üë∂ Lapsi Avatar AR</h1>
        <div class="subtitle">
            Kokeile olevasi lapsi Vision Pro -laseilla!<br>
            Avatar tulee n√§kym√§√§n kehoosi kiinnitettyn√§ todellisessa maailmassa.
        </div>
        
        <button id="start-button">K√§ynnist√§ AR-Avatar</button>
        
        <div id="status">Tarkistetaan Vision Pro -tukea...</div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Alustetaan AR-ymp√§rist√∂√§...</p>
        </div>

        <div class="info-panel">
            <h3>Vision Pro -AR toimii n√§in:</h3>
            <p>1. Paina "K√§ynnist√§ AR-Avatar"</p>
            <p>2. Vision Pro k√§ytt√§√§ pass-through -kameraa</p>
            <p>3. N√§et oman ymp√§rist√∂si ja avatarin kehossasi</p>
            <p>4. <strong>Ei ruutua</strong> - n√§et suoraan maailman lasien kautta</p>
            <p>5. Vihre√§ valo yl√§laidassa = kamera aktiivinen ‚úÖ</p>
        </div>
    </div>

    <button id="exit-button">Lopeta AR</button>
    <div class="debug-info" id="debug-info"></div>

    <script>
        // Vision Pro WebXR -toteutus
        let xrSession = null;
        let gl = null;
        let animationFrameId = null;

        // DOM-elementit
        const xrContainer = document.getElementById('xr-container');
        const webglCanvas = document.getElementById('webgl-canvas');
        const uiContainer = document.getElementById('ui-container');
        const startButton = document.getElementById('start-button');
        const exitButton = document.getElementById('exit-button');
        const statusElement = document.getElementById('status');
        const loadingElement = document.getElementById('loading');
        const debugInfo = document.getElementById('debug-info');

        // P√§ivit√§ status
        function updateStatus(message, isError = false) {
            statusElement.textContent = message;
            statusElement.style.color = isError ? '#ff6b6b' : '#4ECDC4';
            console.log('Status:', message);
        }

        // P√§ivit√§ debug-tiedot
        function updateDebugInfo(info) {
            debugInfo.textContent = info;
        }

        // Tarkista XR-tuki Vision Pro:lle
        async function checkXRSupport() {
            updateDebugInfo('Tarkistetaan WebXR-tukea...');
            
            if (!navigator.xr) {
                updateStatus('WebXR ei saatavilla. K√§yt√§ Vision Pro -laseja Safarilla.', true);
                return false;
            }

            try {
                // Vision Pro k√§ytt√§√§ yleens√§ immersive-vr pass-through:lla
                updateDebugInfo('Tarkistetaan immersive-vr -tukea...');
                const vrSupported = await navigator.xr.isSessionSupported('immersive-vr');
                
                if (vrSupported) {
                    updateStatus('Vision Pro AR-tila tuettu!');
                    updateDebugInfo('immersive-vr tuettu (pass-through AR)');
                    return 'vr';
                }

                // Tai immersive-ar
                updateDebugInfo('Tarkistetaan immersive-ar -tukea...');
                const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
                
                if (arSupported) {
                    updateStatus('Vision Pro AR-tila tuettu!');
                    updateDebugInfo('immersive-ar tuettu');
                    return 'ar';
                }

                updateStatus('Vision Pro AR-ei saatavilla.', true);
                updateDebugInfo('Ei XR-tukea');
                return false;

            } catch (error) {
                console.error('XR-tarkistus ep√§onnistui:', error);
                updateStatus('Vision Pro -tarkistus ep√§onnistui.', true);
                updateDebugInfo('XR-virhe: ' + error.message);
                return false;
            }
        }

        // Alusta WebGL
        function initWebGL() {
            try {
                gl = webglCanvas.getContext('webgl', {
                    xrCompatible: true,
                    alpha: false,
                    antialias: true,
                    depth: true,
                    stencil: false
                });

                if (!gl) {
                    throw new Error('WebGL ei saatavilla');
                }

                // Yksinkertaiset WebGL-asetukset
                gl.clearColor(0.0, 0.0, 0.0, 0.0); // L√§pin√§kyv√§ tausta
                gl.enable(gl.DEPTH_TEST);
                gl.enable(gl.CULL_FACE);

                updateDebugInfo('WebGL alustettu');
                return true;

            } catch (error) {
                console.error('WebGL alustus ep√§onnistui:', error);
                updateDebugInfo('WebGL-virhe: ' + error.message);
                return false;
            }
        }

        // K√§ynnist√§ XR-kokemus
        async function startXRExperience() {
            try {
                loadingElement.style.display = 'block';
                startButton.disabled = true;
                updateStatus('K√§ynnistet√§√§n Vision Pro AR:aa...');
                updateDebugInfo('Aloitetaan XR');

                // Alusta WebGL ensin
                if (!initWebGL()) {
                    throw new Error('WebGL alustus ep√§onnistui');
                }

                const xrSupport = await checkXRSupport();
                
                if (xrSupport) {
                    await startXRSession(xrSupport);
                } else {
                    throw new Error('XR-tukea ei saatavilla');
                }

            } catch (error) {
                console.error('XR-k√§ynnistys ep√§onnistui:', error);
                loadingElement.style.display = 'none';
                startButton.disabled = false;
                updateStatus('AR-k√§ynnistys ep√§onnistui: ' + error.message, true);
                updateDebugInfo('Lopullinen virhe: ' + error.message);
            }
        }

        // K√§ynnist√§ XR-sessio
        async function startXRSession(mode) {
            try {
                updateStatus(`K√§ynnistet√§√§n ${mode.toUpperCase()}-sessiota...`);
                updateDebugInfo(`K√§ynnistet√§√§n ${mode}`);

                const sessionType = mode === 'ar' ? 'immersive-ar' : 'immersive-vr';
                
                // Vision Pro -optimoitu session alustus
                const session = await navigator.xr.requestSession(sessionType, {
                    requiredFeatures: ['local'],
                    optionalFeatures: ['dom-overlay', 'layers', 'light-estimation']
                });

                xrSession = session;
                
                // Tee WebGL XR-yhteensopivaksi
                await gl.makeXRCompatible();
                
                // Aseta render√∂intitila
                const layer = new XRWebGLLayer(session, gl);
                session.updateRenderState({ 
                    baseLayer: layer,
                    depthNear: 0.1,
                    depthFar: 100.0
                });

                // Aseta canvas koko
                webglCanvas.width = layer.framebufferWidth;
                webglCanvas.height = layer.framebufferHeight;

                // Siirry XR-n√§kym√§√§n
                setupXRView();

                // Aloita render√∂inti
                animationFrameId = session.requestAnimationFrame(onXRFrame);

                // K√§sittele session p√§√§ttyminen
                session.addEventListener('end', onXRSessionEnded);

                updateStatus('Vision Pro AR aktiivinen! Liiku ymp√§riins√§ n√§hd√§ksesi avatarin.');
                updateDebugInfo(`${mode} sessio aktiivinen`);

            } catch (error) {
                console.error(`${mode}-sessio ep√§onnistui:`, error);
                throw error;
            }
        }

        // Aseta XR-n√§kym√§
        function setupXRView() {
            xrContainer.style.display = 'block';
            webglCanvas.style.display = 'block';
            uiContainer.classList.add('hidden');
            exitButton.style.display = 'block';
            loadingElement.style.display = 'none';
        }

        // XR-render√∂intisilmukka
        function onXRFrame(time, frame) {
            if (!xrSession) return;

            const pose = frame.getViewerPose(xrSession.renderState.referenceSpace);
            
            if (pose) {
                const layer = xrSession.renderState.baseLayer;
                gl.bindFramebuffer(gl.FRAMEBUFFER, layer.framebuffer);
                
                // Tyhjenn√§ n√§ytt√∂ l√§pin√§kyv√§ll√§
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

                // Render√∂i jokaiselle n√§kym√§lle (silm√§t)
                for (const view of pose.views) {
                    const viewport = layer.getViewport(view);
                    gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);
                    
                    // T√§ss√§ voitaisiin render√∂id√§ 3D-avaratit
                    // Mutta nyt tyhjennet√§√§n vain n√§ytt√∂ jotta Vision Pro:n
                    // oma pass-through -kuva n√§kyy taustalla
                }
            }

            // Jatka render√∂inti√§
            animationFrameId = xrSession.requestAnimationFrame(onXRFrame);
        }

        // K√§sittele XR-session p√§√§ttyminen
        function onXRSessionEnded() {
            console.log('XR-sessio p√§√§ttynyt');
            updateDebugInfo('Session p√§√§ttynyt');
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            resetToInitialState();
        }

        // Lopeta XR-kokemus
        function endXRExperience() {
            if (xrSession) {
                xrSession.end();
            } else {
                resetToInitialState();
            }
        }

        // Palauta alkutila
        function resetToInitialState() {
            xrContainer.style.display = 'none';
            webglCanvas.style.display = 'none';
            uiContainer.classList.remove('hidden');
            exitButton.style.display = 'none';
            loadingElement.style.display = 'none';
            startButton.disabled = false;
            
            updateStatus('AR-kokemus p√§√§ttynyt. Voit k√§ynnist√§√§ uudestaan!');
            updateDebugInfo('Alkutila palautettu');
        }

        // Alusta sovellus
        async function initializeApp() {
            console.log('Alustetaan Vision Pro Lapsi Avatar -sovellusta...');
            updateDebugInfo('Alustetaan...');

            const xrSupported = await checkXRSupport();
            
            if (xrSupported) {
                startButton.addEventListener('click', startXRExperience);
                exitButton.addEventListener('click', endXRExperience);
                
                updateStatus('Valmis! Paina "K√§ynnist√§ AR-Avatar" aloittaaksesi.');
                updateDebugInfo('Valmis, odotetaan k√§ytt√§j√§√§');
            } else {
                startButton.disabled = true;
            }
        }

        // K√§ynnist√§ sovellus
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // K√§sittele virheet
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            updateStatus('Tapahtui odottamaton virhe.', true);
            updateDebugInfo('Global virhe: ' + event.error.message);
        });

    </script>
</body>
</html>
