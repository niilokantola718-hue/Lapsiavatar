<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>6-vuotiaan VR-huone</title>
<style>
html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#000; }
#ui {
  position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:12px; background:rgba(0,0,0,0.7); z-index:999; color:#fff;
}
button {
  padding:14px 22px; border-radius:10px; border:none; font-size:16px;
  background:linear-gradient(135deg,#4ECDC4,#FF6B6B); color:#fff; cursor:pointer;
}
#status { max-width:80%; text-align:center; }
canvas { display:block; width:100%; height:100%; }
</style>
</head>
<body>
<div id="ui">
  <button id="startBtn">Käynnistä VR-huone 6-vuotiaan näkökulmasta</button>
  <div id="status">Paina käynnistääksesi kokemuksen</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
const TARGET_EYE_HEIGHT = 1.1; // 6-vuotiaan silmien korkeus
let scene, camera, renderer, world, avatar;
const ui = document.getElementById('ui');
const status = document.getElementById('status');
const startBtn = document.getElementById('startBtn');

function setStatus(msg){ status.textContent = msg; console.log(msg); }

function initScene(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0xcfe6ff);

  camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.01, 100);

  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  const ambient = new THREE.HemisphereLight(0xffffff, 0x888888, 0.8);
  scene.add(ambient);
  const sun = new THREE.DirectionalLight(0xfff7e6, 0.9);
  sun.position.set(3,5,2);
  scene.add(sun);

  world = new THREE.Group();
  scene.add(world);

  createRoomAndFurniture();
  createAvatar();

  window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
}

function createAvatar(){
  avatar = new THREE.Group();
  const head = new THREE.Mesh(new THREE.SphereGeometry(0.16, 24, 24),
    new THREE.MeshStandardMaterial({ color: 0xffe0b0, metalness:0, roughness:0.6 })
  );
  head.position.y = 0.16;
  avatar.add(head);

  const body = new THREE.Mesh(new THREE.CylinderGeometry(0.16,0.18,0.45,24),
    new THREE.MeshStandardMaterial({ color: 0x4776E6, metalness:0, roughness:0.6 })
  );
  body.position.y = -0.2;
  avatar.add(body);

  avatar.scale.set(1.3,1.3,1.3);
  world.add(avatar);
}

function createRoomAndFurniture(){
  const roomWidth = 6, roomDepth = 6, roomHeight = 2.6;

  // Lattia - parketti
  const floorMat = new THREE.MeshStandardMaterial({ color:0x8B5A2B, roughness:0.7 });
  const floor = new THREE.Mesh(new THREE.PlaneGeometry(roomWidth, roomDepth), floorMat);
  floor.rotation.x = -Math.PI/2;
  floor.position.y = 0;
  world.add(floor);

  // Refleksipisteet
  for(let i=0;i<20;i++){
    const dot = new THREE.Mesh(new THREE.CircleGeometry(0.03,8),
      new THREE.MeshStandardMaterial({ color:0xffffff, opacity:0.3, transparent:true }));
    dot.position.set(Math.random()*roomWidth-roomWidth/2,0.01,Math.random()*roomDepth-roomDepth/2);
    dot.rotation.x = -Math.PI/2;
    world.add(dot);
  }

  // Seinät
  const wallMat = new THREE.MeshStandardMaterial({ color:0xf6f6f2, roughness:0.9 });
  const backWall = new THREE.Mesh(new THREE.PlaneGeometry(roomWidth, roomHeight), wallMat);
  backWall.position.set(0, roomHeight/2 , -roomDepth/2);
  world.add(backWall);
  const frontWall = new THREE.Mesh(new THREE.PlaneGeometry(roomWidth, roomHeight), wallMat);
  frontWall.rotation.y = Math.PI;
  frontWall.position.set(0, roomHeight/2 , roomDepth/2);
  world.add(frontWall);
  const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(roomDepth, roomHeight), wallMat);
  leftWall.rotation.y = Math.PI/2;
  leftWall.position.set(-roomWidth/2, roomHeight/2, 0);
  world.add(leftWall);
  const rightWall = leftWall.clone();
  rightWall.rotation.y = -Math.PI/2;
  rightWall.position.set(roomWidth/2, roomHeight/2, 0);
  world.add(rightWall);

  // Katto
  const ceiling = new THREE.Mesh(new THREE.PlaneGeometry(roomWidth, roomDepth),
    new THREE.MeshStandardMaterial({ color:0xf8f8f8 }));
  ceiling.rotation.x = Math.PI/2;
  ceiling.position.y = roomHeight;
  world.add(ceiling);

  // Huonekalut
  const table = new THREE.Mesh(new THREE.BoxGeometry(1.6,0.08,0.8),
    new THREE.MeshStandardMaterial({ color:0x8B5A2B, roughness:0.6 }));
  table.position.set(0,0.75,-1.2);
  world.add(table);

  const chairMat = new THREE.MeshStandardMaterial({ color:0x5C3A21, roughness:0.7 });
  const chair1 = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.9,0.5), chairMat);
  chair1.position.set(-0.9,0.45,-1.25);
  world.add(chair1);
  const chair2 = chair1.clone();
  chair2.position.set(0.9,0.45,-1.25);
  world.add(chair2);

  const sofa = new THREE.Mesh(new THREE.BoxGeometry(2.0,0.8,0.9),
    new THREE.MeshStandardMaterial({ color:0x5b8aa8, roughness:0.7 }));
  sofa.position.set(1.6,0.4,0.5);
  world.add(sofa);

  const cabinet = new THREE.Mesh(new THREE.BoxGeometry(1.0,2.0,0.5),
    new THREE.MeshStandardMaterial({ color:0x6b4a2f, roughness:0.8 }));
  cabinet.position.set(-2.2,1.0,1.8);
  world.add(cabinet);

  // Läppäri
  const laptop = new THREE.Mesh(new THREE.BoxGeometry(0.35,0.02,0.25),
    new THREE.MeshStandardMaterial({ color:0x333333, metalness:0.1, roughness:0.7 }));
  laptop.position.set(0,0.79,-1.2);
  world.add(laptop);
}

function render(timestamp, frame){
  if(renderer.xr.isPresenting){
    const xrCam = renderer.xr.getCamera(camera);
    const camPos = new THREE.Vector3().setFromMatrixPosition(xrCam.matrixWorld);
    const camQuat = new THREE.Quaternion().setFromRotationMatrix(xrCam.matrixWorld);

    camPos.y = TARGET_EYE_HEIGHT; // 6-vuotiaan silmien korkeus
    camera.position.copy(camPos);
    camera.quaternion.copy(camQuat);

    avatar.position.copy(camPos);
    avatar.position.y = camPos.y - 0.35;
    avatar.position.z = camPos.z - 0.5;
    avatar.quaternion.copy(camQuat);
  }
  renderer.render(scene, camera);
}

async function startVRSession(){
  if(!navigator.xr){ setStatus('WebXR ei tuettu tässä selaimessa'); return; }
  try{
    setStatus('Käynnistetään VR-sessio...');
    const session = await navigator.xr.requestSession('immersive-vr', { optionalFeatures: ['local-floor','bounded-floor'] });
    await renderer.xr.setSession(session);
    ui.style.display = 'none';
    setStatus('VR-sessio käynnistetty! Liiku ja näe maailman 6-vuotiaan silmin.');
    renderer.setAnimationLoop(render);
  }catch(err){
    setStatus('VR-sessio epäonnistui: ' + err.message);
    console.error(err);
  }
}

initScene();
startBtn.addEventListener('click', startVRSession);
</script>
</body>
</html>
