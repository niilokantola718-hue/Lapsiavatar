<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lapsi Avatar - AR 6-vuotias</title>
    <style>
        body { margin:0; padding:0; overflow:hidden; font-family:Arial,sans-serif; background:#000; }
        #ui {
            position:absolute; top:0; left:0; width:100%; height:100%;
            display:flex; flex-direction:column; justify-content:center; align-items:center;
            z-index:1000; background:rgba(0,0,0,0.8);
        }
        button {
            padding:15px 30px; font-size:18px; margin:10px;
            border:none; border-radius:10px; cursor:pointer;
            background:#4CAF50; color:white;
        }
        #status { color:white; margin-top:20px; text-align:center; max-width:80%; }
    </style>
</head>
<body>
<div id="ui">
    <button id="startButton">Käynnistä AR - 6-vuotias näkökulma</button>
    <div id="status">Valmis aloittamaan AR</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script>
let scene, camera, renderer, avatar;
let xrSession = null;
const statusEl = document.getElementById('status');

function updateStatus(msg) { statusEl.textContent = msg; console.log(msg); }

async function init(){
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);

    // Kamera 6-vuotiaan silmien korkeudella (~1.15 m)
    camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.01, 100);
    camera.position.set(0,1.15,0);

    renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Valaistus
    const ambientLight = new THREE.AmbientLight(0xffffff,0.7); scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff,0.8); directionalLight.position.set(5,10,5); scene.add(directionalLight);

    // Luo huone
    createRoom();

    // Luo parkettilattia epätasaisuuksineen
    createFloor();

    // Luo huonekaluja
    createFurniture();

    // Luo lapsiavatar
    createAvatar();

    window.addEventListener('resize', onWindowResize);
    document.getElementById('startButton').addEventListener('click', startARSession);

    updateStatus('Valmis aloittamaan AR - paina "Käynnistä"');
}

function createRoom(){
    // Huone: seinät ja katto
    const wallMaterial = new THREE.MeshPhongMaterial({color:0xF0F0F0});
    const floorMaterial = new THREE.MeshPhongMaterial({color:0xdeb887});
    const ceilingMaterial = new THREE.MeshPhongMaterial({color:0xFFFFFF});

    // Seinät
    const wallGeo = new THREE.BoxGeometry(0.1,3,5);
    const leftWall = new THREE.Mesh(wallGeo, wallMaterial); leftWall.position.set(-2.5,1.5,0); scene.add(leftWall);
    const rightWall = new THREE.Mesh(wallGeo, wallMaterial); rightWall.position.set(2.5,1.5,0); scene.add(rightWall);

    const backWall = new THREE.Mesh(new THREE.BoxGeometry(5,3,0.1), wallMaterial); backWall.position.set(0,1.5,-2.5); scene.add(backWall);
    const frontWall = new THREE.Mesh(new THREE.BoxGeometry(5,3,0.1), wallMaterial); frontWall.position.set(0,1.5,2.5); scene.add(frontWall);

    // Katto
    const ceiling = new THREE.Mesh(new THREE.BoxGeometry(5,0.1,5), ceilingMaterial); ceiling.position.set(0,3,0); scene.add(ceiling);
}

function createFloor(){
    const floorGeo = new THREE.PlaneGeometry(5,5,20,20);
    const floorMat = new THREE.MeshPhongMaterial({color:0xdeb887, side:THREE.DoubleSide});
    // Epätasaisuuksia
    for(let i=0;i<floorGeo.attributes.position.count;i++){
        const y = (Math.random()-0.5)*0.02; // ±2cm
        floorGeo.attributes.position.setY(i,y);
    }
    floorGeo.computeVertexNormals();
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI/2;
    floor.position.y = 0;
    scene.add(floor);
}

function createFurniture(){
    // Pöytä
    const table = new THREE.Mesh(new THREE.BoxGeometry(1,0.75,0.6), new THREE.MeshPhongMaterial({color:0x8B4513}));
    table.position.set(0,0.375,0); scene.add(table);

    // Tuolit
    for(let i=-1;i<=1;i+=2){
        const chair = new THREE.Mesh(new THREE.BoxGeometry(0.4,0.45,0.4), new THREE.MeshPhongMaterial({color:0xA0522D}));
        chair.position.set(i*0.6,0.225,0.8); scene.add(chair);
    }

    // Kaappi
    const cupboard = new THREE.Mesh(new THREE.BoxGeometry(1,2,0.5), new THREE.MeshPhongMaterial({color:0x654321}));
    cupboard.position.set(-1.8,1,1.5); scene.add(cupboard);
}

function createAvatar(){
    avatar = new THREE.Group();

    const headGeo = new THREE.SphereGeometry(0.15,16,16);
    const headMat = new THREE.MeshPhongMaterial({color:0xFFD700, transparent:true, opacity:0.8});
    const head = new THREE.Mesh(headGeo, headMat); head.position.y=0.15; avatar.add(head);

    const bodyGeo = new THREE.CylinderGeometry(0.12,0.15,0.3,16);
    const bodyMat = new THREE.MeshPhongMaterial({color:0x4169E1, transparent:true, opacity:0.8});
    const body = new THREE.Mesh(bodyGeo, bodyMat); body.position.y=-0.15; avatar.add(body);

    avatar.position.set(0,-0.3,-0.5);
    scene.add(avatar);
}

async function startARSession(){
    updateStatus('Käynnistetään AR-sessio...');
    if(!navigator.xr){
        updateStatus('❌ WebXR ei tuettu.');
        return;
    }

    try{
        const sessionInit = {requiredFeatures:['local-floor']};
        const session = await navigator.xr.requestSession('immersive-ar', sessionInit);
        xrSession = session;
        await renderer.xr.setSession(session);
        document.getElementById('ui').style.display='none';
        renderer.setAnimationLoop(render);
        updateStatus('AR käynnissä - 6-vuotiaan näkökulma!');
    }catch(e){
        updateStatus('AR-sessio epäonnistui: '+e.message);
        console.error(e);
    }
}

function onWindowResize(){
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function render(){
    if(avatar && camera){
        avatar.position.copy(camera.position);
        avatar.position.y -= 0.3;
        avatar.position.z -= 0.5;
        avatar.rotation.copy(camera.rotation);
    }
    renderer.render(scene,camera);
}

window.addEventListener('load', init);
</script>
</body>
</html>
