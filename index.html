<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lapsi Avatar VR</title>
<style>
  body { margin:0; overflow:hidden; background:black; }
  #info {
    position:absolute; top:20px; left:20px; color:white; background:rgba(0,0,0,0.7); padding:15px; border-radius:10px;
  }
  button { padding:10px 20px; font-size:16px; margin:5px; cursor:pointer; }
</style>
</head>
<body>
<div id="info">
  <h2>Lapsi Avatar VR</h2>
  <button id="startButton">ðŸš€ KÃ¤ynnistÃ¤ VR</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script>
let camera, scene, renderer, avatar;
let xrSession = null;

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87CEEB);

  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.01, 1000);
  camera.position.set(0, 0.95, 3); // 4-vuotiaan silmien korkeus

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  const ambientLight = new THREE.AmbientLight(0xffffff,0.6);
  scene.add(ambientLight);

  const directionalLight = new THREE.DirectionalLight(0xffffff,0.8);
  directionalLight.position.set(5,10,5);
  scene.add(directionalLight);

  createFloor();
  createVirtualObjects();
  createAvatar();

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  document.getElementById('startButton').addEventListener('click', startVR);
  animate();
}

function createFloor() {
  const floorGeometry = new THREE.PlaneGeometry(10,10,10,10);
  for(let i=0;i<floorGeometry.attributes.position.count;i++){
    floorGeometry.attributes.position.setY(i, Math.random()*0.02); // pieni epÃ¤tasaisuus
  }
  const floorMaterial = new THREE.MeshStandardMaterial({color:0xdeb887, side:THREE.DoubleSide});
  const floor = new THREE.Mesh(floorGeometry,floorMaterial);
  floor.rotation.x = -Math.PI/2;
  floor.position.y = 0; // fyysinen lattia, kamera 0.95m ylÃ¤puolella
  scene.add(floor);
}

function createVirtualObjects() {
  // PÃ¶ytÃ¤
  const table = new THREE.Mesh(
    new THREE.BoxGeometry(1.5,0.75,0.8),
    new THREE.MeshStandardMaterial({color:0x8B4513})
  );
  table.position.set(0,0.375,-1.5);
  scene.add(table);

  // Tuoli
  const chair = new THREE.Mesh(
    new THREE.BoxGeometry(0.5,0.45,0.5),
    new THREE.MeshStandardMaterial({color:0xA0522D})
  );
  chair.position.set(1,-0.025,-1);
  scene.add(chair);

  // Lelut
  for(let i=0;i<5;i++){
    const size=0.2+Math.random()*0.2;
    const geometry = Math.random()>0.5 ? new THREE.SphereGeometry(size,16,16) : new THREE.BoxGeometry(size,size,size);
    const material = new THREE.MeshStandardMaterial({color:Math.random()*0xffffff});
    const toy = new THREE.Mesh(geometry,material);
    toy.position.set((Math.random()-0.5)*3,size/2,-2+(Math.random()-0.5));
    scene.add(toy);
  }
}

function createAvatar() {
  const group = new THREE.Group();
  const body = new THREE.Mesh(
    new THREE.CylinderGeometry(0.25,0.25,0.8,8),
    new THREE.MeshStandardMaterial({color:0x4169E1,transparent:true,opacity:0.3})
  );
  body.position.y = 0.4;
  group.add(body);

  const head = new THREE.Mesh(
    new THREE.SphereGeometry(0.18,16,16),
    new THREE.MeshStandardMaterial({color:0xFFEBCD,transparent:true,opacity:0.3})
  );
  head.position.y = 0.9;
  group.add(head);

  avatar = group;
  scene.add(avatar);
}

async function startVR() {
  if(!navigator.xr){
    alert("WebXR ei saatavilla tÃ¤ssÃ¤ selaimessa");
    return;
  }
  try{
    const supported = await navigator.xr.isSessionSupported('immersive-vr');
    if(!supported) { alert("VR ei tuettu"); return; }

    xrSession = await navigator.xr.requestSession('immersive-vr');
    renderer.xr.setSession(xrSession);

    // Kamera avatarin pÃ¤Ã¤lle (lapsen nÃ¤kÃ¶kulma)
    const head = new THREE.Group();
    head.position.set(0,0.95,0);
    avatar.add(head);
    head.add(camera);
    camera.position.set(0,0,0);

    xrSession.addEventListener('end',()=>{
      xrSession=null;
      if(camera.parent) camera.parent.remove(camera);
      camera.position.set(0,0.95,3);
    });
  }catch(e){
    alert("VR kÃ¤ynnistys epÃ¤onnistui: "+e.message);
  }
}

function animate() {
  renderer.setAnimationLoop(()=>{
    renderer.render(scene,camera);
  });
}

window.addEventListener('load', init);
</script>
</body>
</html>
