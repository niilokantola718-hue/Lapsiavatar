<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtuaalihuone – Vision Pro AR-VR</title>
    <style>
        body { margin:0; overflow:hidden; background:black; color:white; font-family:-apple-system, BlinkMacSystemFont, sans-serif; }
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.85); z-index: 1000;
        }
        button {
            padding: 20px 40px; font-size: 22px; border: none; border-radius: 12px;
            background: linear-gradient(45deg, #007aff, #34c759); color: white; cursor: pointer;
        }
        #status { margin-top: 20px; text-align: center; }
    </style>
</head>
<body>
    <div id="ui">
        <button id="startButton">Käynnistä virtuaalihuone</button>
        <div id="status">Valmistellaan...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

    <script>
    let scene, camera, renderer, room, avatar;

    const status = document.getElementById('status');
    const ui = document.getElementById('ui');
    const startButton = document.getElementById('startButton');

    function setStatus(msg) {
        status.textContent = msg;
        console.log(msg);
    }

    async function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.xr.setReferenceSpaceType('local-floor');
        document.body.appendChild(renderer.domElement);

        // Valaistus
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dir = new THREE.DirectionalLight(0xffffff, 0.6);
        dir.position.set(1, 2, 1);
        scene.add(dir);

        // Luo virtuaalihuone (kuutio, jonka sisäpinnat näkyvät)
        const roomSize = 4;
        const roomGeometry = new THREE.BoxGeometry(roomSize, roomSize, roomSize);
        const roomMaterial = new THREE.MeshStandardMaterial({
            color: 0x404040,
            side: THREE.BackSide,
            roughness: 1.0,
            metalness: 0.0
        });
        room = new THREE.Mesh(roomGeometry, roomMaterial);
        scene.add(room);

        // Lattia
        const floorGeometry = new THREE.PlaneGeometry(4, 4, 16, 16);
        const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x705438 });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -2;
        scene.add(floor);

        // Pieni lapsi-avatar (kokeellinen)
        const body = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.2, 0.4, 16), new THREE.MeshStandardMaterial({ color: 0x3a7bd5 }));
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.12, 16, 16), new THREE.MeshStandardMaterial({ color: 0xffd700 }));
        head.position.y = 0.25;
        avatar = new THREE.Group();
        avatar.add(body);
        avatar.add(head);
        avatar.position.set(0, -1.8, -0.8);
        scene.add(avatar);

        startButton.addEventListener('click', startAR);
        window.addEventListener('resize', onWindowResize);
        setStatus("Valmis. Paina 'Käynnistä virtuaalihuone'");
    }

    async function startAR() {
        try {
            setStatus("Käynnistetään AR (virtuaalihuone)...");
            const session = await navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['local-floor'] });
            await renderer.xr.setSession(session);
            ui.style.display = 'none';
            renderer.setAnimationLoop(render);
            setStatus("Virtuaalihuone käynnistynyt Vision Prossa!");
        } catch (e) {
            console.error(e);
            setStatus("Virhe: " + e.message);
        }
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function render() {
        // Huone seuraa hieman katsetta, jotta olo on keskellä
        if (room && renderer.xr.isPresenting) {
            room.position.set(0, -0.1, 0);
        }
        renderer.render(scene, camera);
    }

    window.addEventListener('load', init);
    </script>
</body>
</html>
