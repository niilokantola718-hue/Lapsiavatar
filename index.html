<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>4-vuotiaan VR-huone (Vision Pro)</title>
<style>
  html,body { height:100%; margin:0; background:#000; font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',sans-serif; }
  #ui {
    position: absolute; left: 20px; top: 20px; z-index: 200;
    background: rgba(0,0,0,0.6); color: #fff; padding: 12px 14px; border-radius: 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  button { display:inline-block; background:#4ECDC4; color:#052; border:0; padding:10px 14px; border-radius:8px; font-size:16px; cursor:pointer; }
  #status { margin-top:8px; font-size:14px; color:#fff; }
  canvas { display:block; }
</style>
</head>
<body>
  <div id="ui">
    <button id="startBtn">üöÄ K√§ynnist√§ VR</button>
    <div id="status">Valmiina ‚Äî varmista HTTPS + WebXR ON.</div>
  </div>

  <!-- Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>

  <script>
  // --- Perusmuuttujat ---
  let scene, camera, renderer, avatarGroup, xrSession = null;
  const statusEl = document.getElementById('status');
  const startBtn = document.getElementById('startBtn');

  function setStatus(text, isError=false){
    statusEl.textContent = text;
    statusEl.style.color = isError ? '#ffb3b3' : '#fff';
    console.log(text);
  }

  // --- Alustus ---
  function initScene(){
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB); // taivas / neutraali v√§ri

    // Kamera ‚Äî kiinte√§ "virtuaalinen" silmien korkeus 4-vuotiaalle ~0.95 m
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.01, 1000);
    camera.position.set(0, 0.95, 3);

    renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    renderer.setClearColor(0x000000, 0); // l√§pin√§kyv√§ setti mahdollistaa Vision Pro -l√§pin√§kyvyyden
    document.body.appendChild(renderer.domElement);

    // Kevyt valaistus
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const dir = new THREE.DirectionalLight(0xffffff, 0.6);
    dir.position.set(5, 10, 5);
    scene.add(dir);

    // Luo huone
    createRoom();

    // Luo avatar (l√§pin√§kyv√§ malli)
    createAvatar();

    window.addEventListener('resize', onWindowResize, false);
    animate(); // k√§ynnistet√§√§n rendering loop heti (ei XR:√§√§)
  }

  // --- Huone (sein√§t, lattia, katto) ---
  function createRoom(){
    // Lattia ‚Äî parketti, matala tessellaatio, pieni ep√§tasaisuus
    const floorGeo = new THREE.PlaneGeometry(10, 10, 16, 16);
    const pos = floorGeo.attributes.position;
    for(let i=0;i<pos.count;i++){
      // Lis√§√§ pieni√§ korkeusvaihteluita (vain Y-koordinaatti)
      const x = pos.getX(i), y = pos.getY(i), z = pos.getZ(i);
      pos.setZ(i, z + (Math.random()-0.5)*0.02); // pieni kohouma
    }
    floorGeo.computeVertexNormals();
    const floorMat = new THREE.MeshStandardMaterial({ color: 0xDEB887, roughness: 0.8 });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI/2;
    floor.receiveShadow = false;
    scene.add(floor);

    // Sein√§t ‚Äî yksinkertaistettu rytmi
    const wallMat = new THREE.MeshStandardMaterial({ color: 0xF7F7F7, roughness: 0.9 });
    const backWall = new THREE.Mesh(new THREE.PlaneGeometry(10,3), wallMat); backWall.position.set(0,1.5,-5); scene.add(backWall);
    const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(10,3), wallMat); leftWall.position.set(-5,1.5,0); leftWall.rotation.y = Math.PI/2; scene.add(leftWall);
    const rightWall = new THREE.Mesh(new THREE.PlaneGeometry(10,3), wallMat); rightWall.position.set(5,1.5,0); rightWall.rotation.y = -Math.PI/2; scene.add(rightWall);
    const frontWall = new THREE.Mesh(new THREE.PlaneGeometry(10,3), wallMat); frontWall.position.set(0,1.5,5); frontWall.rotation.y = Math.PI; scene.add(frontWall);

    // Katto (yksinkertainen)
    const ceiling = new THREE.Mesh(new THREE.PlaneGeometry(10,10), new THREE.MeshStandardMaterial({ color:0xEFEFEF }));
    ceiling.rotation.x = Math.PI/2; ceiling.position.y = 3; scene.add(ceiling);

    // Huonekalut ‚Äî kevyt geometria
    const table = new THREE.Mesh(new THREE.BoxGeometry(1.2,0.7,0.8), new THREE.MeshStandardMaterial({ color:0x8B5E3C }));
    table.position.set(0,0.35,-1.0);
    scene.add(table);

    const chair = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.45,0.5), new THREE.MeshStandardMaterial({ color:0xA0522D }));
    chair.position.set(0.8,0.225,-0.8);
    scene.add(chair);

    const sofa = new THREE.Mesh(new THREE.BoxGeometry(1.6,0.8,0.9), new THREE.MeshStandardMaterial({ color:0x6B8E23 }));
    sofa.position.set(-2.0,0.4,-1.8);
    scene.add(sofa);

    // muutama lelu huoneen mittakaavan havainnollistamiseksi
    const colors = [0xFF6B6B, 0x4ECDC4, 0xFFEAA7];
    for(let i=0;i<5;i++){
      const s = 0.18 + Math.random()*0.25;
      const geom = (Math.random()>0.5) ? new THREE.SphereGeometry(s,12,12) : new THREE.BoxGeometry(s,s,s);
      const mat = new THREE.MeshStandardMaterial({ color: colors[i % colors.length] });
      const m = new THREE.Mesh(geom, mat);
      m.position.set((Math.random()-0.5)*3, s/2, -2 + (Math.random()-0.5)*2);
      scene.add(m);
    }
  }

  // --- Avatar (yksinkertainen, ei parentoi kameraa) ---
  function createAvatar(){
    avatarGroup = new THREE.Group();
    const body = new THREE.Mesh(new THREE.CylinderGeometry(0.28, 0.28, 0.85, 12),
      new THREE.MeshStandardMaterial({ color:0x4169E1, transparent:true, opacity:0.28 }) );
    body.position.y = 0.425;
    avatarGroup.add(body);

    const head = new THREE.Mesh(new THREE.SphereGeometry(0.2, 12, 12),
      new THREE.MeshStandardMaterial({ color:0xFFEBCD, transparent:true, opacity:0.28 }) );
    head.position.y = 0.95;
    avatarGroup.add(head);

    // Aseta avatar alkuun kameran eteen hieman alemmaksi (ei parentoituna)
    avatarGroup.position.set(0, 0, -0.5);
    scene.add(avatarGroup);
  }

  // --- K√§ynnist√§ VR (immersive-vr) ---
  async function startXR(){
    if(!navigator.xr){
      setStatus('WebXR ei saatavilla t√§ss√§ selaimessa.', true);
      return;
    }

    setStatus('Kysyt√§√§n VR-tukea‚Ä¶');
    try {
      const supported = await navigator.xr.isSessionSupported('immersive-vr');
      if(!supported){
        setStatus('immersive-vr ei tuettu laitteellasi.', true);
        return;
      }

      // K√§ytt√§j√§n painallus -> aloitetaan session
      xrSession = await navigator.xr.requestSession('immersive-vr', { optionalFeatures: [] });
      await renderer.xr.setSession(xrSession);

      setStatus('VR k√§ynnistetty ‚Äî olet 4-vuotiaan n√§k√∂kulmasta. Liiku tai katso ymp√§ri.');
      // √§l√§ tee session aikana kamera-parentointeja tai odottamattomia transform-operaatioita
      // Poistuessa siivotaan
      xrSession.addEventListener('end', () => {
        xrSession = null;
        setStatus('VR-sessio p√§√§ttynyt.'); 
      });
    } catch (err) {
      console.error('requestSession error:', err);
      setStatus('VR k√§ynnistys ep√§onnistui: ' + (err && err.message ? err.message : String(err)), true);
    }
  }

  // --- Render loop (ei siirtele kameraa parent-operaatioilla) ---
  function animate(){
    renderer.setAnimationLoop(() => {
      // Jos XR on k√§ynniss√§, kamera on XR-kamera ‚Äî voimme p√§ivitt√§√§ avatarin sijainnin varovaisesti
      if (xrSession && avatarGroup){
        // Kopioidaan XR-kameran maailmapositio avatarille pienell√§ offsetilla
        const camWorldPos = new THREE.Vector3();
        camera.getWorldPosition(camWorldPos);
        // Aseta avatar hieman kameran eteen ja alapuolelle niin ett√§ tuntuu kehon√§kyv√§lt√§
        avatarGroup.position.set(camWorldPos.x, camWorldPos.y - 0.5, camWorldPos.z - 0.5);
        // kopioi rotaatio varovaisesti
        const camQuat = new THREE.Quaternion();
        camera.getWorldQuaternion(camQuat);
        avatarGroup.quaternion.copy(camQuat);
      }
      renderer.render(scene, camera);
    });
  }

  function onWindowResize(){
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  // --- K√§ynnistykset ---
  window.addEventListener('load', () => {
    initScene();
    startBtn.addEventListener('click', () => {
      setStatus('K√§ynnistet√§√§n VR‚Ä¶');
      startXR();
    });
  });

  </script>
</body>
</html>
