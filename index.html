<!doctype html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Lapsen näkökulma — VR-huone Vision Pro</title>
<style>
html,body{height:100%;margin:0}
body{background:#000;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;overflow:hidden}
#ui{
  position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:12px;background:rgba(0,0,0,0.7);z-index:999;color:#fff;
}
button{
  padding:14px 22px;border-radius:10px;border:none;font-size:16px;
  background:linear-gradient(135deg,#4ECDC4,#FF6B6B);color:#fff;cursor:pointer;
}
#status{max-width:80%;text-align:center}
canvas{width:100%;height:100%;display:block}
</style>
</head>
<body>
<div id="ui">
  <button id="startBtn">Käynnistä VR-huone</button>
  <div id="status">Paina käynnistääksesi kokemuksen — näkökulma 6-vuotiaan tasolla (~1.1 m)</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
const TARGET_EYE_HEIGHT = 1.1;
const WORLD_BASE_SCALE = 1.0;
const SMOOTH_Y = 0.12;
let scene, camera, renderer;
let world, avatar;
let xrRefSpace = null;
const ui = document.getElementById('ui');
const status = document.getElementById('status');
const startBtn = document.getElementById('startBtn');

function setStatus(t){ status.textContent = t; console.log(t); }

function initScene(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0xcfe6ff);

  camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.01, 100);
  camera.position.set(0, TARGET_EYE_HEIGHT, 0);

  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  renderer.outputEncoding = THREE.sRGBEncoding;
  document.body.appendChild(renderer.domElement);

  const ambient = new THREE.HemisphereLight(0xffffff, 0x888888, 0.8);
  scene.add(ambient);
  const sun = new THREE.DirectionalLight(0xfff7e6, 0.9);
  sun.position.set(3,5,2);
  scene.add(sun);

  world = new THREE.Group();
  world.scale.set(WORLD_BASE_SCALE, WORLD_BASE_SCALE, WORLD_BASE_SCALE);
  scene.add(world);

  createRoomAndFurniture();
  createAvatar();

  window.addEventListener('resize', onResize);
}

function createAvatar(){
  avatar = new THREE.Group();
  const head = new THREE.Mesh(new THREE.SphereGeometry(0.16, 24, 24),
    new THREE.MeshStandardMaterial({ color: 0xffe0b0, metalness:0.0, roughness:0.6 })
  );
  head.position.y = 0.16;
  avatar.add(head);

  const body = new THREE.Mesh(new THREE.CylinderGeometry(0.16,0.18,0.45,24),
    new THREE.MeshStandardMaterial({ color: 0x4776E6, metalness:0.0, roughness:0.6 })
  );
  body.position.y = -0.2;
  avatar.add(body);

  avatar.scale.set(1.3,1.3,1.3);
  world.add(avatar);
}

function createRoomAndFurniture(){
  const roomWidth = 6, roomDepth = 6, roomHeight = 2.6;
  const floorMat = new THREE.MeshStandardMaterial({ color:0xCFA97B, roughness:0.6 });
  const floor = new THREE.Mesh(new THREE.PlaneGeometry(roomWidth, roomDepth), floorMat);
  floor.rotation.x = -Math.PI/2;
  world.add(floor);

  const wallMat = new THREE.MeshStandardMaterial({ color:0xf6f6f2, roughness:0.9 });
  const backWall = new THREE.Mesh(new THREE.PlaneGeometry(roomWidth, roomHeight), wallMat);
  backWall.position.set(0, roomHeight/2, -roomDepth/2);
  world.add(backWall);

  const frontWall = new THREE.Mesh(new THREE.PlaneGeometry(roomWidth, roomHeight), wallMat);
  frontWall.rotation.y = Math.PI;
  frontWall.position.set(0, roomHeight/2, roomDepth/2);
  world.add(frontWall);

  const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(roomDepth, roomHeight), wallMat);
  leftWall.rotation.y = Math.PI/2;
  leftWall.position.set(-roomWidth/2, roomHeight/2, 0);
  world.add(leftWall);

  const rightWall = leftWall.clone();
  rightWall.rotation.y = -Math.PI/2;
  rightWall.position.set(roomWidth/2, roomHeight/2, 0);
  world.add(rightWall);

  const ceiling = new THREE.Mesh(new THREE.PlaneGeometry(roomWidth, roomDepth),
    new THREE.MeshStandardMaterial({ color:0xf8f8f8 }));
  ceiling.rotation.x = Math.PI/2;
  ceiling.position.y = roomHeight;
  world.add(ceiling);

  // Furniture
  const table = new THREE.Mesh(new THREE.BoxGeometry(1.6,0.08,0.8),
    new THREE.MeshStandardMaterial({ color:0x8B5A2B, roughness:0.6 }));
  table.position.set(0,0.75,-1.2);
  world.add(table);

  const chairMat = new THREE.MeshStandardMaterial({ color:0x5C3A21, roughness:0.7 });
  const chair1 = new THREE.Mesh(new THREE.BoxGeometry(0.5,0.9,0.5), chairMat);
  chair1.position.set(-0.9,0.45,-1.25);
  world.add(chair1);
  const chair2 = chair1.clone();
  chair2.position.set(0.9,0.45,-1.25);
  world.add(chair2);

  const sofa = new THREE.Mesh(new THREE.BoxGeometry(2.0,0.8,0.9),
    new THREE.MeshStandardMaterial({ color:0x5b8aa8, roughness:0.7 }));
  sofa.position.set(1.6,0.4,0.5);
  world.add(sofa);

  const cabinet = new THREE.Mesh(new THREE.BoxGeometry(1.0,2.0,0.5),
    new THREE.MeshStandardMaterial({ color:0x6b4a2f, roughness:0.8 }));
  cabinet.position.set(-2.2,1.0,1.8);
  world.add(cabinet);
}

function onResize(){
  if(!camera || !renderer) return;
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function getViewerY(frame){
  try{
    if(!xrRefSpace) return null;
    const pose = frame.getViewerPose(xrRefSpace);
    if(!pose) return null;
    const p = pose.transform.position;
    return (p && typeof p.y === 'number') ? p.y : null;
  }catch(e){return null;}
}

function render(timestamp, frame){
  if(renderer.xr.isPresenting && frame){
    const viewerY = getViewerY(frame);
    if(typeof viewerY==='number'){
      const desiredY = TARGET_EYE_HEIGHT - (viewerY*world.scale.y);
      world.position.y += (desiredY - world.position.y)*SMOOTH_Y;
    }
    if(avatar){
      const xrCam = renderer.xr.getCamera(camera);
      const camPos = new THREE.Vector3().setFromMatrixPosition(xrCam.matrixWorld);
      const camQuat = new THREE.Quaternion().setFromRotationMatrix(xrCam.matrixWorld);
      avatar.position.copy(camPos);
      avatar.position.y -= 0.35;
      avatar.position.z -= 0.5;
      avatar.quaternion.copy(camQuat);
    }
  }
  renderer.render(scene,camera);
}

async function startSession(){
  if(!navigator.xr){ setStatus('WebXR ei tuettu tässä selaimessa'); return; }
  try{
    setStatus('Pyydetään immersive-ar -sessio...');
    const session = await navigator.xr.requestSession('immersive-ar',{
      optionalFeatures:['local-floor'] // varma feature Vision Prolle
    });
    await renderer.xr.setSession(session);
    xrRefSpace = await renderer.xr.getReferenceSpace();

    ui.style.display='none';
    setStatus('Kokemus käynnissä — maailma pysyy 6-vuotiaan näkökulmalla.');

    session.addEventListener('end',()=>{ ui.style.display='flex'; setStatus('Istunto lopetettu'); });

    renderer.setAnimationLoop(render);
  }catch(err){
    console.error(err);
    setStatus('Istunnon aloitus epäonnistui: ' + (err.message||err));
  }
}

initScene();
startBtn.addEventListener
