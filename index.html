<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lapsi Avatar AR - Vision Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #ar-button {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: linear-gradient(45deg, #007AFF, #5856D6);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 8px 20px rgba(0, 122, 255, 0.3);
            transition: all 0.3s ease;
        }

        #ar-button:hover {
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 12px 25px rgba(0, 122, 255, 0.4);
        }

        #ar-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: translateX(-50%) scale(1);
        }

        #ar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 999;
            backdrop-filter: blur(10px);
        }

        #exit-ar {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 12px 24px;
            background: #FF3B30;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            cursor: pointer;
            z-index: 1001;
        }

        .status-message {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            padding: 0 20px;
        }

        .loading {
            display: none;
            text-align: center;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #info-panel {
            position: fixed;
            top: 30px;
            left: 30px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 15px;
            font-size: 14px;
            max-width: 300px;
            backdrop-filter: blur(10px);
            display: none;
        }

        /* Lapsimaisen avatarin tyylit */
        .child-like {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <canvas id="xr-canvas"></canvas>
    </div>

    <button id="ar-button">Käynnistä AR-Avatar</button>
    
    <div id="ar-overlay">
        <div class="status-message">AR-avatar aktiivinen! Katso ympärillesi.</div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Alustetaan AR-ympäristöä...</p>
        </div>
    </div>

    <button id="exit-ar" style="display: none;">Lopeta AR</button>
    
    <div id="info-panel">
        <h3>Lapsi Avatar AR</h3>
        <p>Kokeile elää lapsuutta uudestaan!</p>
    </div>

    <script>
        // Pääkomponentit
        let xrSession = null;
        let xrReferenceSpace = null;
        let gl = null;
        let animationFrameId = null;

        // DOM-elementit
        const canvas = document.getElementById('xr-canvas');
        const arButton = document.getElementById('ar-button');
        const arOverlay = document.getElementById('ar-overlay');
        const exitArButton = document.getElementById('exit-ar');
        const loadingElement = document.getElementById('loading');
        const infoPanel = document.getElementById('info-panel');

        // Avatarin geometria (yksinkertainen lapsimainen hahmo)
        const avatarVertices = new Float32Array([
            // Pää (pallo - yksinkertaistettu)
            0.0, 0.3, 0.0,
            0.1, 0.25, 0.0,
            0.0, 0.25, 0.1,
            -0.1, 0.25, 0.0,
            0.0, 0.25, -0.1,
            
            // Vartalo
            0.0, 0.25, 0.0,
            0.0, -0.1, 0.0,
            
            // Kädet
            -0.2, 0.15, 0.0,
            -0.2, -0.05, 0.0,
            0.2, 0.15, 0.0,
            0.2, -0.05, 0.0,
            
            // Jalat
            0.0, -0.1, 0.0,
            -0.1, -0.4, 0.0,
            0.0, -0.1, 0.0,
            0.1, -0.4, 0.0
        ]);

        // Värit (värikäs lapsimainen palette)
        const avatarColors = new Float32Array([
            // Pää (vaaleanpunainen)
            1.0, 0.8, 0.9,
            1.0, 0.8, 0.9,
            1.0, 0.8, 0.9,
            1.0, 0.8, 0.9,
            1.0, 0.8, 0.9,
            
            // Vartalo (sininen)
            0.2, 0.5, 1.0,
            0.2, 0.5, 1.0,
            
            // Kädet (vaaleanpunainen)
            1.0, 0.8, 0.9,
            1.0, 0.8, 0.9,
            1.0, 0.8, 0.9,
            1.0, 0.8, 0.9,
            
            // Jalat (sininen)
            0.2, 0.5, 1.0,
            0.2, 0.5, 1.0,
            0.2, 0.5, 1.0,
            0.2, 0.5, 1.0
        ]);

        // Shaderit
        const vertexShaderSource = `#version 300 es
            in vec3 aVertexPosition;
            in vec3 aVertexColor;
            uniform mat4 uModelViewMatrix;
            uniform mat4 uProjectionMatrix;
            out vec3 vColor;
            
            void main(void) {
                gl_Position = uProjectionMatrix * uModelViewMatrix * vec4(aVertexPosition, 1.0);
                gl_PointSize = 8.0;
                vColor = aVertexColor;
            }
        `;

        const fragmentShaderSource = `#version 300 es
            precision highp float;
            in vec3 vColor;
            out vec4 fragColor;
            
            void main(void) {
                fragColor = vec4(vColor, 1.0);
            }
        `;

        // Tarkista AR-tuki
        async function checkARSupport() {
            if (!navigator.xr) {
                arButton.textContent = 'WebXR ei tuettu';
                arButton.disabled = true;
                return false;
            }

            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (!supported) {
                    arButton.textContent = 'AR ei tuettu laitteessa';
                    arButton.disabled = true;
                    return false;
                }

                console.log('AR-tila tuettu!');
                return true;
            } catch (error) {
                console.error('AR-tuen tarkistus epäonnistui:', error);
                arButton.textContent = 'AR-tarkistus epäonnistui';
                arButton.disabled = true;
                return false;
            }
        }

        // Alusta WebGL
        function initWebGL() {
            try {
                gl = canvas.getContext('webgl2', { 
                    xrCompatible: true,
                    alpha: false,
                    antialias: true,
                    depth: true,
                    stencil: false
                });

                if (!gl) {
                    throw new Error('WebGL 2.0 ei saatavilla');
                }

                // Luo shaderit
                const vertexShader = compileShader(gl.VERTEX_SHADER, vertexShaderSource);
                const fragmentShader = compileShader(gl.FRAGMENT_SHADER, fragmentShaderSource);
                const program = createProgram(vertexShader, fragmentShader);
                
                gl.useProgram(program);

                // Alusta puskurit
                initBuffers(program);
                
                console.log('WebGL alustettu onnistuneesti');
                return true;
                
            } catch (error) {
                console.error('WebGL alustus epäonnistui:', error);
                return false;
            }
        }

        // Kääntää shaderin
        function compileShader(type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);
            
            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                const error = gl.getShaderInfoLog(shader);
                gl.deleteShader(shader);
                throw new Error(`Shaderin kääntäminen epäonnistui: ${error}`);
            }
            
            return shader;
        }

        // Luo shader-ohjelma
        function createProgram(vertexShader, fragmentShader) {
            const program = gl.createProgram();
            gl.attachShader(program, vertexShader);
            gl.attachShader(program, fragmentShader);
            gl.linkProgram(program);
            
            if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
                const error = gl.getProgramInfoLog(program);
                throw new Error(`Ohjelman linkitys epäonnistui: ${error}`);
            }
            
            return program;
        }

        // Alusta geometria puskurit
        function initBuffers(program) {
            // Vertex puskuri
            const vertexBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, avatarVertices, gl.STATIC_DRAW);
            
            const positionAttributeLocation = gl.getAttribLocation(program, "aVertexPosition");
            gl.enableVertexAttribArray(positionAttributeLocation);
            gl.vertexAttribPointer(positionAttributeLocation, 3, gl.FLOAT, false, 0, 0);

            // Väri puskuri
            const colorBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, avatarColors, gl.STATIC_DRAW);
            
            const colorAttributeLocation = gl.getAttribLocation(program, "aVertexColor");
            gl.enableVertexAttribArray(colorAttributeLocation);
            gl.vertexAttribPointer(colorAttributeLocation, 3, gl.FLOAT, false, 0, 0);

            // OpenGL asetukset
            gl.enable(gl.DEPTH_TEST);
            gl.enable(gl.CULL_FACE);
            gl.clearColor(0.0, 0.0, 0.0, 0.0);
        }

        // Piirrä avatar
        function drawAvatar(view, projectionMatrix) {
            const program = gl.getParameter(gl.CURRENT_PROGRAM);
            
            // Hae uniformien sijainnit
            const uModelViewMatrix = gl.getUniformLocation(program, "uModelViewMatrix");
            const uProjectionMatrix = gl.getUniformLocation(program, "uProjectionMatrix");
            
            // Aseta projektio matriisi
            gl.uniformMatrix4fv(uProjectionMatrix, false, projectionMatrix);
            
            // Lasketaan aikaan perustuva animaatio
            const time = performance.now() * 0.001;
            const bounce = Math.sin(time * 2) * 0.1;
            const sway = Math.sin(time * 1.5) * 0.05;
            
            // Avatarin sijainti (1.5 metriä eteenpäin, hieman alhaalla)
            const avatarMatrix = new Float32Array([
                1.0, 0.0, 0.0, 0.0,
                0.0, 1.0, 0.0, 0.0 + bounce,
                0.0, 0.0, 1.0, -1.5,
                sway, -0.3 + bounce, 0.0, 1.0
            ]);
            
            gl.uniformMatrix4fv(uModelViewMatrix, false, avatarMatrix);
            
            // Piirrä avatar pisteinä ja viivoina (yksinkertainen hahmo)
            gl.drawArrays(gl.POINTS, 0, avatarVertices.length / 3);
            gl.drawArrays(gl.LINE_STRIP, 5, 2);  // Vartalo
            gl.drawArrays(gl.LINES, 7, 4);       // Kädet
            gl.drawArrays(gl.LINES, 11, 4);      // Jalat
        }

        // Renderöintisilmukka
        function renderFrame(time, frame) {
            if (!xrSession) return;

            const pose = frame.getViewerPose(xrReferenceSpace);
            if (!pose) return;

            const layer = xrSession.renderState.baseLayer;
            gl.bindFramebuffer(gl.FRAMEBUFFER, layer.framebuffer);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            // Piirrä jokaiselle näkymälle (silmät)
            for (const view of pose.views) {
                const viewport = layer.getViewport(view);
                gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);
                drawAvatar(view, view.projectionMatrix);
            }

            animationFrameId = xrSession.requestAnimationFrame(renderFrame);
        }

        // Käynnistä AR-sessio
        async function startARSession() {
            try {
                loadingElement.style.display = 'block';
                arButton.disabled = true;

                // Tarkista kamera-oikeudet
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(track => track.stop());
                } catch (err) {
                    console.warn('Kamera-oikeuksia ei voitu varmistaa:', err);
                }

                // Pyydä AR-sessio
                const session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local', 'hit-test'],
                    optionalFeatures: ['dom-overlay', 'light-estimation']
                });

                xrSession = session;
                console.log('AR-sessio aloitettu');

                // Tee WebGL yhteensopivaksi XR:n kanssa
                await gl.makeXRCompatible();
                
                // Pyydä viiteavaruus
                xrReferenceSpace = await session.requestReferenceSpace('local');
                
                // Aseta renderöintitila
                const layer = new XRWebGLLayer(session, gl);
                session.updateRenderState({ 
                    baseLayer: layer,
                    depthNear: 0.1,
                    depthFar: 100.0
                });

                canvas.width = layer.framebufferWidth;
                canvas.height = layer.framebufferHeight;

                // Päällystä näkymä
                arOverlay.style.display = 'flex';
                exitArButton.style.display = 'block';
                arButton.style.display = 'none';
                infoPanel.style.display = 'block';
                loadingElement.style.display = 'none';

                // Aloita renderöinti
                animationFrameId = session.requestAnimationFrame(renderFrame);

                // Käsittele session päättyminen
                session.addEventListener('end', onSessionEnded);
                session.addEventListener('visibilitychange', onVisibilityChange);

            } catch (error) {
                console.error('AR-session käynnistys epäonnistui:', error);
                loadingElement.style.display = 'none';
                arButton.disabled = false;
                alert('AR:n käynnistys epäonnistui: ' + error.message);
            }
        }

        // Käsittele session päättyminen
        function onSessionEnded() {
            console.log('AR-sessio päättynyt');
            xrSession = null;
            
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            
            arOverlay.style.display = 'none';
            exitArButton.style.display = 'none';
            arButton.style.display = 'block';
            infoPanel.style.display = 'none';
            arButton.disabled = false;
        }

        // Käsittele näkyvyyden muutos
        function onVisibilityChange() {
            if (xrSession && xrSession.visibilityState === 'visible-blurred') {
                console.log('AR-sessio taustalle');
            }
        }

        // Lopeta AR-sessio
        function endARSession() {
            if (xrSession) {
                xrSession.end();
            }
        }

        // Alusta sovellus
        async function initializeApp() {
            console.log('Alustetaan sovellusta...');
            
            // Alusta WebGL
            if (!initWebGL()) {
                arButton.textContent = 'WebGL epäonnistui';
                arButton.disabled = true;
                return;
            }
            
            // Tarkista AR-tuki
            const arSupported = await checkARSupport();
            if (arSupported) {
                arButton.addEventListener('click', startARSession);
                exitArButton.addEventListener('click', endARSession);
                
                console.log('Sovellus alustettu valmiiksi');
            }
        }

        // Käynnistä sovellus kun sivu on ladattu
        window.addEventListener('load', initializeApp);

        // Käsittele virheet
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        // Resize käsittely
        window.addEventListener('resize', () => {
            if (gl && canvas) {
                canvas.style.width = '100%';
                canvas.style.height = '100%';
            }
        });

    </script>
</body>
</html>

