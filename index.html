<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lapsi Avatar VR - Uusi Koodi</title>
<style>
body { margin: 0; overflow: hidden; background: black; }
#vrButton { position: absolute; top: 20px; left: 20px; padding: 15px 30px; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; z-index:100; }
#statusMessage { position: absolute; top: 80px; left: 20px; color: white; font-size: 18px; z-index:100; }
</style>
</head>
<body>
<button id="vrButton">ðŸš€ KÃ¤ynnistÃ¤ VR</button>
<div id="statusMessage">Valmis!</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script>
let scene, camera, renderer, avatar;
let xrSession = null;

function init() {
    // Scene
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB);

    // Kamera 4-vuotiaan silmien korkeudelle (~1.0 m)
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.01, 1000);
    camera.position.set(0,1.0,3);

    // Renderer
    renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Valaistus
    const ambient = new THREE.AmbientLight(0xffffff,0.6);
    scene.add(ambient);
    const dirLight = new THREE.DirectionalLight(0xffffff,0.8);
    dirLight.position.set(10,20,10);
    scene.add(dirLight);

    // Luo huone
    createRoom();

    // Luo avatar
    createAvatar();

    // Resize
    window.addEventListener('resize', onWindowResize);

    // Animaatio
    animate();
}

function createRoom(){
    // Lattia (parketti, epÃ¤tasaisuuksia)
    const floorGeom = new THREE.PlaneGeometry(5,5,10,10);
    for(let i=0;i<floorGeom.attributes.position.count;i++){
        const z = (Math.random()-0.5)*0.02;
        floorGeom.attributes.position.setZ(i,z);
    }
    const floorMat = new THREE.MeshStandardMaterial({color:0xdeb887, side:THREE.DoubleSide});
    const floor = new THREE.Mesh(floorGeom, floorMat);
    floor.rotation.x = -Math.PI/2;
    floor.position.y = 0;
    scene.add(floor);

    // SeinÃ¤t
    const wallMat = new THREE.MeshStandardMaterial({color:0xf0f0f0});
    const walls = [
        new THREE.Mesh(new THREE.PlaneGeometry(5,2.5), wallMat),
        new THREE.Mesh(new THREE.PlaneGeometry(5,2.5), wallMat),
        new THREE.Mesh(new THREE.PlaneGeometry(5,2.5), wallMat),
        new THREE.Mesh(new THREE.PlaneGeometry(5,2.5), wallMat)
    ];
    walls[0].position.set(0,1.25,-2.5);
    walls[1].position.set(0,1.25,2.5); walls[1].rotation.y=Math.PI;
    walls[2].position.set(-2.5,1.25,0); walls[2].rotation.y=Math.PI/2;
    walls[3].position.set(2.5,1.25,0); walls[3].rotation.y=-Math.PI/2;
    walls.forEach(w=>scene.add(w));

    // Katto
    const ceiling = new THREE.Mesh(new THREE.PlaneGeometry(5,5), wallMat);
    ceiling.position.y=2.5;
    ceiling.rotation.x=Math.PI/2;
    scene.add(ceiling);

    // PÃ¶ytÃ¤
    const table = new THREE.Mesh(
        new THREE.BoxGeometry(1,0.6,0.8),
        new THREE.MeshStandardMaterial({color:0x8B4513})
    );
    table.position.set(0,0.3,-1);
    scene.add(table);

    // Tuoli
    const chair = new THREE.Mesh(
        new THREE.BoxGeometry(0.5,0.4,0.5),
        new THREE.MeshStandardMaterial({color:0xA0522D})
    );
    chair.position.set(0.8,0.2,-0.8);
    scene.add(chair);
}

function createAvatar(){
    avatar = new THREE.Group();
    const body = new THREE.Mesh(
        new THREE.CylinderGeometry(0.25,0.25,0.8,8),
        new THREE.MeshStandardMaterial({color:0x4169E1,transparent:true,opacity:0.3})
    );
    body.position.y=0.4;
    avatar.add(body);

    const head = new THREE.Mesh(
        new THREE.SphereGeometry(0.18,16,16),
        new THREE.MeshStandardMaterial({color:0xFFEBCD,transparent:true,opacity:0.3})
    );
    head.position.y=0.9;
    avatar.add(head);

    scene.add(avatar);
}

async function startVR(){
    if(!navigator.xr){ alert("WebXR ei saatavilla."); return;}
    try{
        const supported = await navigator.xr.isSessionSupported('immersive-vr');
        if(!supported){ alert("VR ei tuettu"); return;}
        xrSession = await navigator.xr.requestSession('immersive-vr');
        await renderer.xr.setSession(xrSession);
        document.getElementById('vrButton').style.display='none';
        document.getElementById('statusMessage').textContent='VR kÃ¤ynnistetty! Olet nyt 4-vuotiaan nÃ¤kÃ¶kulmassa.';
        xrSession.addEventListener('end',()=>{
            xrSession=null;
            document.getElementById('vrButton').style.display='inline-block';
            document.getElementById('statusMessage').textContent='VR-sessio pÃ¤Ã¤ttynyt.';
        });
    }catch(e){
        alert("VR kÃ¤ynnistys epÃ¤onnistui: "+e.message);
    }
}

function onWindowResize(){
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate(){
    renderer.setAnimationLoop(()=>{
        renderer.render(scene,camera);
    });
}

document.getElementById('vrButton').addEventListener('click', startVR);
window.addEventListener('load', init);
</script>
</body>
</html>
