'<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lapsi Avatar - VR</title>
<style>
  body { margin:0; padding:0; overflow:hidden; background:black; font-family: Arial,sans-serif; }
  #info { position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.9);
         color:white; padding:20px; border-radius:10px; z-index:100; max-width:500px;
         border:2px solid #4CAF50; }
  button { padding:15px 30px; font-size:18px; background:#4CAF50; color:white;
           border:none; border-radius:10px; cursor:pointer; margin:10px 5px; transition:all 0.3s; }
  button:hover { transform: scale(1.05); }
  #vrButton { background:#9C27B0; }
  .status-box { background:rgba(255,255,255,0.1); padding:15px; border-radius:8px; margin:15px 0; }
  #heightIndicator { position:absolute; bottom:20px; left:20px; background:rgba(0,0,0,0.9);
                     color:white; padding:15px; border-radius:10px; border:2px solid #FF6B6B; display:none; }
</style>
</head>
<body>
<div id="info">
  <h2>üßí Lapsi Avatar - VR</h2>
  <div class="status-box">
    <p>WebXR VR: K√§ynnist√§ VR n√§hd√§ksesi lapsen perspektiivist√§</p>
  </div>
  <button id="vrButton">üöÄ K√§ynnist√§ VR</button>
  <div class="status-box">
    <div id="statusMessage">Valmis! Paina k√§ynnist√§√§ksesi VR-tilan.</div>
  </div>
</div>
<div id="heightIndicator">
  <h3>üìè Lapsen Korkeus: 115cm</h3>
  <p>Olet nyt 6-vuotiaan n√§k√∂kulmasta</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script>
let camera, scene, renderer, avatar;
let xrSession = null;

function updateStatus(msg) { document.getElementById('statusMessage').textContent = msg; }

function init(){
  updateStatus("Alustetaan VR...");
  
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87CEEB);

  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.01, 1000);
  camera.position.set(0, 1.15, 5); // 6-vuotiaan silmien korkeus

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  const ambient = new THREE.AmbientLight(0xffffff,0.6);
  scene.add(ambient);
  const directional = new THREE.DirectionalLight(0xffffff,0.8);
  directional.position.set(10,20,5);
  scene.add(directional);

  createVirtualObjects();
  createAvatar();
  setupEventHandlers();
  animate();
  updateStatus("Valmis! Paina VR.");
}

function createVirtualObjects(){
  const colors=[0xFF6B6B,0x4ECDC4,0x45B7D1,0x96CEB4,0xFFEAA7];

  // Parkettilattia ep√§tasaisuuksineen
  const floorGeo=new THREE.PlaneGeometry(10,10,20,20);
  for(let i=0;i<floorGeo.attributes.position.count;i++){
    floorGeo.attributes.position.setY(i, Math.random()*0.02);
  }
  const floorMat=new THREE.MeshStandardMaterial({color:0xDEB887,side:THREE.DoubleSide});
  const floor=new THREE.Mesh(floorGeo,floorMat);
  floor.rotation.x=-Math.PI/2;
  floor.position.y=0;
  scene.add(floor);

  // P√∂yt√§ 75cm
  const table=new THREE.Mesh(new THREE.BoxGeometry(2,0.75,1.5), new THREE.MeshStandardMaterial({color:0x8B4513}));
  table.position.set(0,0.375,-2);
  scene.add(table);

  // Tuoli 45cm
  const chair=new THREE.Mesh(new THREE.BoxGeometry(0.7,0.45,0.7), new THREE.MeshStandardMaterial({color:0xA0522D}));
  chair.position.set(1.5,0.225,-1);
  scene.add(chair);

  // Lelut
  for(let i=0;i<8;i++){
    const size=0.3+Math.random()*0.4;
    const geom=Math.random()>0.5? new THREE.SphereGeometry(size,16,16) : new THREE.BoxGeometry(size,size,size);
    const mat=new THREE.MeshStandardMaterial({color: colors[Math.floor(Math.random()*colors.length)]});
    const toy=new THREE.Mesh(geom,mat);
    toy.position.set((Math.random()-0.5)*8, size/2, -3+(Math.random()-0.5)*4);
    scene.add(toy);
  }
}

function createAvatar(){
  const group=new THREE.Group();
  const body=new THREE.Mesh(new THREE.CylinderGeometry(0.25,0.25,0.8,8), new THREE.MeshStandardMaterial({color:0x4169E1,transparent:true,opacity:0.3}));
  body.position.y=0.4;
  group.add(body);
  const head=new THREE.Mesh(new THREE.SphereGeometry(0.18,16,16), new THREE.MeshStandardMaterial({color:0xFFEBCD,transparent:true,opacity:0.3}));
  head.position.y=0.9;
  group.add(head);
  avatar=group;
  scene.add(avatar);
}

function setupEventHandlers(){
  document.getElementById('vrButton').addEventListener('click', startVRSession);
  window.addEventListener('resize', onWindowResize);
}

async function startVRSession(){
  if(!navigator.xr){ alert("WebXR ei saatavilla t√§ss√§ selaimessa."); return; }
  try{
    const supported = await navigator.xr.isSessionSupported('immersive-vr');
    if(!supported){ alert("VR ei tuettu t√§ss√§ laitteessa"); return; }
    xrSession = await navigator.xr.requestSession('immersive-vr');
    await renderer.xr.setSession(xrSession);

    // Liitet√§√§n kamera lapsiavatarin p√§√§h√§n
    const head=new THREE.Group();
    head.position.set(0,1.15,0);
    avatar.add(head);
    head.add(camera);
    camera.position.set(0,0,0);

    document.getElementById('info').style.display='none';
    document.getElementById('heightIndicator').style.display='block';
    updateStatus("VR k√§ynnistetty! Olet 6-vuotiaan n√§k√∂kulmasta.");

    xrSession.addEventListener('end', ()=>{
      xrSession=null;
      document.getElementById('info').style.display='block';
      document.getElementById('heightIndicator').style.display='none';
      if(camera.parent) camera.parent.remove(camera);
      camera.position.set(0,1.15,5);
      updateStatus("VR p√§√§ttynyt.");
    });
  }catch(e){ updateStatus("‚ùå VR ep√§onnistui: "+e.message); alert("VR ep√§onnistui: "+e.message);}
}

function onWindowResize(){
  camera.aspect=window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth,window.innerHeight);
}

function animate(){
  renderer.setAnimationLoop(()=>{
    if(xrSession){
      avatar.position.copy(camera.position);
      avatar.position.y-=1.15; // kamera avatarin p√§√§ss√§
      avatar.rotation.copy(camera.rotation);
    }
    renderer.render(scene,camera);
  });
}

window.addEventListener('load',init);
</script>
</body>
</html>
